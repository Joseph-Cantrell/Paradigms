
<head>
	<title>Mario!</title>
	<meta charset="UTF-8">
</head>
<body>
<br>
<canvas id="myCanvas" width=1000" height="600" style="border:1px solid #cccccc;"></canvas>

<script type="text/javascript">

class Sprite
{
	
	
	constructor(x, y, w, h, image_url, update_method, onclick_method, model)
	{
		this.x = x;
		this.y = y;
		this.w = w;
		this.h = h;
		this.vert_vel = 0;
		this.prev_x = 0;
		this.prev_y = 0;
		this.bottomCollision = false;
		this.frames_since_ground = 0;
		this.image = new Image();
		this.image.src = image_url;
		this.update = update_method;
		this.onclick = onclick_method;
		this.model = model
		this.hitCount = 0;
		this.identification = 0;
		this.coinX = 0;
		this.coinY = 0;
		this.newCoin = false;
		this.depleatedCheck = false;
		this.coin;
	}

	ignore_click(x, y)
	{
	}
	
	marioUpdate()
	{
		this.prevPosition();
		this.model.scrollPos = this.x - 100;
	
		this.w = 65;
		this.h = 95;
		this.identification = 1;
		//this.model = m;
		this.vert_vel += 3.14;
		this.y += this.vert_vel;
		
		if(this.y >= 600-95)
		{
			this.y = 600-95;
			this.vert_vel = 0;
			this.frames_since_ground = 0;
			this.bottomCollision = false;
		}
		
		for(let i = 0; i < this.model.sprites.length; i++)
		{
			this.s = this.model.sprites[i];
			// Collision with bricks
			if(this.doesCollide(this,this.s) && !this.s.identification == 1)
			{
				this.bottomCollision = false;
				this.get_Out(this.s);
				this.vert_vel = 0;
				//this.frames_since_ground = 0;
			}
			if(this.s.identification == 4 && this.y < this.s.y + this.s.h && this.prev_y > this.s.y + this.s.h && !this.s.identification == 1)
			{
				this.get_Out(this.s);
				if(!this.bottomCollision)
				{
					this.newCoin = true;
					this.coinX = this.s.x + (75/2);
					this.coinY = this.s.y;
					this.s.hitCount = this.s.hitCount + 1;
					if(this.s.hitCount > 5)
					{
						this.depleatedCheck = true;
					}
					this.bottomCollision = true;
				}
			}
		}
		
		if(this.newCoin && !this.depleatedCheck)
		{		
			this.coin = new Sprite(this.coinX, this.coinY, 0, 0,"coin1.png", Sprite.prototype.coinUpdate, Sprite.prototype.ignore_click,this);
			this.model.sprites.push(this.coin);
		}
		
		this.frames_since_ground ++;
		
	}
	
	coinUpdate()
	{
		this.identification = 2;
		let HVGotten = false;
		
		this.vert_vel += 3.14;

		if(!this.HVGotten)
		{
			this.hori_v = ((Math.random() * ((5 - -5) + 1)) + -5);
			this.HVGotten = true;
		}
		this.x += this.hori_v;
		this.y += this.vert_vel;
	}
	
	brickUpdate()
	{
		this.identification = 3;
	}
	
	coinBrickUpdate()
	{
		this.identification = 4;
		if(this.hitCount > 4)
			this.image.src = "NoCoinBlockPhoto.png";
	}
	
	prevPosition()
	{
		this.prev_x = this.x;
		this.prev_y = this.y;
		//console.log(this.prev_x, " " ,this.prev_y);
	}

	moveLeft()
	{
		this.x = this.x + 10
	}
	moveRight()
	{
		this.x = this.x - 10
	}
	jump()
	{
		if(this.frames_since_ground < 5)
		{
			this.vert_vel -= 9;
			this.y += this.vert_vel;
		}
	}
	
	doesCollide(a,b)
	{
		if (a.x + a.w < b.x) {return false;}
	if (a.x > b.x + b.w) {return false;}
	if (a.y > b.y + b.h) {return false;}
	if (a.y + a.h < b.y) {return false;}	
	return true
	}
	
	get_Out(That)
	{	
		// coming in from the left
		if(this.x + this.w >= That.x && this.prev_x + this.w <= That.x) 
		{	
			console.log("Getting out from left");
			this.x = That.x - 1 - this.w;
			this.y = 100;
			//System.out.println("Colliding Left");
		}
		// coming in from the right
		else if(this.x <= That.x + That.w && this.prev_x >= That.x + That.w) 
		{	
			console.log("Getting out from right");
			this.x =  That.x + That.w + 1;
			this.y = 100;
			//System.out.println("Colliding Right");
		}	
		// coming in from above
		else if(this.y + this.h >= That.y && this.prev_y + this.h <= That.y)
		{
			//console.log("Getting out from top");
			this.vert_vel = 0;
			this.frames_since_ground = 0;
			this.y = That.y - this.h - 1;
			
			//System.out.println("Colliding Top");
		}
		// Coming in from below
		else if(this.y <= That.y + That.h && this.prev_y >= That.y + That.h)
		{
			console.log("Getting out from bottom");
			//console.log(this.y, " ", That.y, " ", That.h);
			this.vert_vel = 0;
			this.frames_since_ground = 6;
			//this.y = That.y + That.h + 1;
			
			//System.out.println("Colliding Bottom");
		}
		/*if(this.x + this.w >= s.x && this.prev_x + this.w <= s.x)
			this.x = s.x - this.w - 1;
		else if(this.x <= s.x + s.w && this.prev_x >= s.x + s.w)
			this.x = s.x + s.w + 1;
		else if(this.y + this.h >= s.y && this.prev_y + this.h <= s.y)
		{
			this.y = s.y - this.h - 1;
			this.vert_vel = 0;
			this.frames_since_ground = 0;
		}
		else if(this.y <= s.y + s.h && this.prev_y >= s.y + s.h)
			this.y = s.y + s.h + 1;*/
	}
	
	sit_still()
	{
	}
}
	
class Model
{
	constructor()
	{
		this.sprites = [];
		this.mario = new Sprite(0, 0, 65, 95,"mario1.png", Sprite.prototype.marioUpdate, Sprite.prototype.ignore_click,this);
		this.sprites.push(this.mario);
		this.scrollPos = 0;
	}

	update()
	{
		for(let i = 0; i < this.sprites.length; i++)
		{
			this.sprites[i].update();
		}
	}
	
	addSprite(type, x, y, w, h)				
	{
		if(type == "CoinBlock")
			this.sprites.push(new Sprite(x, y,75, 75, "CoinBlockPhoto.png", Sprite.prototype.coinBrickUpdate,Sprite.prototype.ignore_click,this));
		else if(type == "Brick")
			this.sprites.push(new Sprite(x, y, 75, 75, "brickPhoto.png", Sprite.prototype.brickUpdate,Sprite.prototype.ignore_click,this));
		else if(type == "Coin")
			this.sprites.push(new Sprite(x, y, 0.1, 0.1, "Coin1.png", Sprite.prototype.coinUpdate,Sprite.prototype.ignore_click,this));
	}

	prevPosition()
	{
		this.mario.prevPosition()
	}
	moveLeft()
	{
		this.mario.moveLeft();
	}
	moveRight()
	{
		this.mario.moveRight();
	}
	jump()
	{
		this.mario.jump();
	}
}




class View
{
	constructor(model)
	{
		this.model = model;
		this.canvas = document.getElementById("myCanvas");
		this.image = new Image();
		this.image.src = "Background.jpg";
	}

	update()
	{
		let ctx = this.canvas.getContext("2d");
		//ctx.clearRect(0, 0, 1000, 500);
		ctx.drawImage(this.image,0,-200)
		for(let i = 0; i < this.model.sprites.length; i++)
		{
			let sprite = this.model.sprites[i];
			ctx.drawImage(sprite.image, sprite.x - this.model.scrollPos, sprite.y);
		}
	}
}







class Controller
{
	constructor(model, view)
	{
		this.model = model;
		this.view = view;
		this.key_right = false;
		this.key_left = false;
		this.key_up = false;
		this.key_down = false;
		let self = this;
		//view.canvas.addEventListener("click", function(event) { self.onClick(event); });
		document.addEventListener('keydown', function(event) { self.keyDown(event); }, false);
		document.addEventListener('keyup', function(event) { self.keyUp(event); }, false);
	}

	/*onClick(event)
	{
		this.model.addSprite("CoinBlock", event.pageX - this.view.canvas.offsetLeft, event.pageY - this.view.canvas.offsetTop, 75, 75);
	}*/

	keyDown(event)
	{
		if(event.keyCode == 39) this.key_right = true;
		else if(event.keyCode == 37) this.key_left = true;
		else if(event.keyCode == 38) this.key_up = true;
		else if(event.keyCode == 40) this.key_down = true;
	}

	keyUp(event)
	{
		if(event.keyCode == 39) this.key_right = false;
		else if(event.keyCode == 37) this.key_left = false;
		else if(event.keyCode == 38) this.key_up = false;
		else if(event.keyCode == 40) this.key_down = false;
	}

	update()
	{
			this.model.sprites.push(new Sprite(0, 400, 75, 75, "brickPhoto.png", Sprite.prototype.brickUpdate,Sprite.prototype.ignore_click,this.model));
			this.model.sprites.push(new Sprite(75, 400, 75, 75, "brickPhoto.png", Sprite.prototype.brickUpdate,Sprite.prototype.ignore_click,this.model));
			this.model.sprites.push(new Sprite(150, 400, 75, 75, "brickPhoto.png", Sprite.prototype.brickUpdate,Sprite.prototype.ignore_click,this.model));
			this.model.sprites.push(new Sprite(225, 400, 75, 75, "brickPhoto.png", Sprite.prototype.brickUpdate,Sprite.prototype.ignore_click,this.model));
			this.model.sprites.push(new Sprite(150, 200, 75, 75, "brickPhoto.png", Sprite.prototype.brickUpdate,Sprite.prototype.ignore_click,this.model));
			this.model.sprites.push(new Sprite(225, 200, 75, 75, "brickPhoto.png", Sprite.prototype.brickUpdate,Sprite.prototype.ignore_click,this.model));
			this.model.sprites.push(new Sprite(300, 200, 75, 75, "brickPhoto.png", Sprite.prototype.brickUpdate,Sprite.prototype.ignore_click,this.model));
			this.model.sprites.push(new Sprite(375, 200, 75, 75, "brickPhoto.png", Sprite.prototype.brickUpdate,Sprite.prototype.ignore_click,this.model));
			this.model.sprites.push(new Sprite(450, 275, 75, 75, "brickPhoto.png", Sprite.prototype.brickUpdate,Sprite.prototype.ignore_click,this.model));
			this.model.sprites.push(new Sprite(525, 350, 75, 75, "brickPhoto.png", Sprite.prototype.brickUpdate,Sprite.prototype.ignore_click,this.model));
			this.model.sprites.push(new Sprite(600, 425, 75, 75, "brickPhoto.png", Sprite.prototype.brickUpdate,Sprite.prototype.ignore_click,this.model));
			this.model.sprites.push(new Sprite(675, 500, 75, 75, "brickPhoto.png", Sprite.prototype.brickUpdate,Sprite.prototype.ignore_click,this.model));
			
			
			this.model.sprites.push(new Sprite(225, 200, 75, 75, "CoinBlockPhoto.png", Sprite.prototype.coinBrickUpdate,Sprite.prototype.ignore_click,this.model));
		
		//this.model.prevPosition();
		let dx = 0;
		let dy = 0;
		if(this.key_right) 
			this.model.moveLeft();
		if(this.key_left)
			this.model.moveRight();
		if(this.key_up)
			this.model.jump();
		this.model.prevPosition();
	}
}





class Game
{
	constructor()
	{
		this.model = new Model();
		this.view = new View(this.model);
		this.controller = new Controller(this.model, this.view);
	}

	onTimer()
	{
		this.controller.update();
		this.model.update();
		this.view.update();
	}
}


let game = new Game();
let timer = setInterval(function() { game.onTimer(); }, 40);

</script>

</body>
